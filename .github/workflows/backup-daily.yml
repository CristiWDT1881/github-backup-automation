name: Backup Zilnic

on:
  schedule:
    - cron: '0 6 * * *'  # 08:00 dimineaÈ›a ora RomÃ¢niei (6 UTC)
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  backup:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository backup
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0
    
    - name: Configurare Git
      run: |
        git config --global user.name "Backup Bot"
        git config --global user.email "cristianiftodexyz@gmail.com"
    
    - name: CreeazÄƒ structura de directoare
      run: |
        mkdir -p archives
        DATE=$(date +%Y-%m-%d)
        TIME=$(date +%H:%M:%S)
        mkdir -p "archives/$DATE"
        echo "BACKUP_DATE=$DATE" >> $GITHUB_ENV
        echo "BACKUP_TIME=$TIME" >> $GITHUB_ENV
        echo "ğŸ“… Backup pentru data: $DATE la ora $TIME"
    
    - name: ObÈ›ine lista repository-urilor
      id: get_repos
      run: |
        echo "ğŸ“‹ ObÈ›in lista repository-urilor de la GitHub..."
        curl -s "https://api.github.com/users/CristiWDT1881/repos?per_page=100&type=all" | \
          jq -r '.[].name' > repos_list.txt
        
        echo "Repository-uri gÄƒsite:"
        cat repos_list.txt
        echo ""
        
        REPO_COUNT=$(cat repos_list.txt | wc -l)
        echo "ğŸ“Š Total: $REPO_COUNT repository-uri"
        echo "total_repos=$REPO_COUNT" >> $GITHUB_OUTPUT
    
    - name: ProceseazÄƒ È™i arhiveazÄƒ repository-uri
      id: process
      run: |
        CHANGED=0
        UNCHANGED=0
        ERRORS=0
        CHANGED_LIST=""
        UNCHANGED_LIST=""
        ERROR_LIST=""
        
        echo "ğŸ”„ Ãncep procesarea repository-urilor..."
        echo ""
        
        while IFS= read -r repo; do
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Repository: $repo"
          
          # Skip repository-ul curent
          if [ "$repo" = "github-backup-automation" ]; then
            echo "âŠ˜ Skip (repository curent de backup)"
            echo ""
            continue
          fi
          
          # GenereazÄƒ nume de director temporar sigur
          TEMP_DIR="temp_$(date +%s)_${RANDOM}"
          
          # CloneazÄƒ repository-ul
          if git clone --quiet --depth=50 "https://github.com/CristiWDT1881/${repo}.git" "$TEMP_DIR" 2>/dev/null; then
            cd "$TEMP_DIR"
            
            # VerificÄƒ modificÄƒri Ã®n ultimele 24 ore
            COMMITS=$(git log --since="24 hours ago" --oneline 2>/dev/null | wc -l)
            
            # ObÈ›ine info despre ultimul commit
            if [ -n "$(git log -1 2>/dev/null)" ]; then
              LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s" 2>/dev/null | head -c 50)
              LAST_COMMIT_DATE=$(git log -1 --pretty=format:"%cr" 2>/dev/null)
              LAST_COMMIT_HASH=$(git log -1 --pretty=format:"%h" 2>/dev/null)
            else
              LAST_COMMIT_MSG="Repository gol"
              LAST_COMMIT_DATE="N/A"
              LAST_COMMIT_HASH="N/A"
            fi
            
            cd ..
            
            # DeterminÄƒ statusul
            if [ "$COMMITS" -gt 0 ]; then
              echo "âœ… MODIFICAT: $COMMITS commit-uri Ã®n ultimele 24h"
              CHANGED=$((CHANGED + 1))
              CHANGED_LIST="${CHANGED_LIST}â€¢ **${repo}** â†’ ${COMMITS} commit(uri) â†’ \`${LAST_COMMIT_HASH}\` ${LAST_COMMIT_MSG} (${LAST_COMMIT_DATE})\n"
              STATUS="MODIFICAT"
            else
              echo "â—‹ NESCHIMBAT: FÄƒrÄƒ modificÄƒri recente"
              UNCHANGED=$((UNCHANGED + 1))
              UNCHANGED_LIST="${UNCHANGED_LIST}â€¢ ${repo} â†’ Ultimul commit: ${LAST_COMMIT_DATE}\n"
              STATUS="NESCHIMBAT"
            fi
            
            # CreeazÄƒ arhivÄƒ pentru fiecare repository
            ARCHIVE_NAME="${repo}_${BACKUP_DATE}.tar.gz"
            echo "ğŸ“¦ Creez arhivÄƒ: $ARCHIVE_NAME"
            
            tar -czf "archives/${BACKUP_DATE}/${ARCHIVE_NAME}" \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='__pycache__' \
              --exclude='*.pyc' \
              --exclude='.env' \
              --exclude='venv' \
              --exclude='.venv' \
              "$TEMP_DIR" 2>/dev/null
            
            if [ -f "archives/${BACKUP_DATE}/${ARCHIVE_NAME}" ]; then
              SIZE=$(du -h "archives/${BACKUP_DATE}/${ARCHIVE_NAME}" | cut -f1)
              echo "âœ“ ArhivÄƒ creatÄƒ: ${SIZE} [${STATUS}]"
            else
              echo "âš ï¸ Eroare la crearea arhivei"
            fi
            
            # CurÄƒÈ›Äƒ directorul temporar
            rm -rf "$TEMP_DIR"
            
          else
            echo "âš ï¸ EROARE: Nu pot clona repository-ul (posibil privat/gol/inaccesibil)"
            ERRORS=$((ERRORS + 1))
            ERROR_LIST="${ERROR_LIST}â€¢ ${repo} â†’ Nu a putut fi accesat\n"
          fi
          
          echo ""
          
        done < repos_list.txt
        
        # Sumar final
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š SUMAR PROCESARE:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Repository-uri cu modificÄƒri: $CHANGED"
        echo "â—‹ Repository-uri fÄƒrÄƒ modificÄƒri: $UNCHANGED"
        echo "âš ï¸ Erori: $ERRORS"
        echo "ğŸ“¦ Total arhive create: $((CHANGED + UNCHANGED))"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # SalveazÄƒ rezultatele pentru paÈ™ii urmÄƒtori
        echo "changed=$CHANGED" >> $GITHUB_OUTPUT
        echo "unchanged=$UNCHANGED" >> $GITHUB_OUTPUT
        echo "errors=$ERRORS" >> $GITHUB_OUTPUT
        echo "total=$((CHANGED + UNCHANGED))" >> $GITHUB_OUTPUT
        
        echo "changed_list<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "unchanged_list<<EOF" >> $GITHUB_OUTPUT
        echo -e "$UNCHANGED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "error_list<<EOF" >> $GITHUB_OUTPUT
        echo -e "$ERROR_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # VerificÄƒ dacÄƒ existÄƒ arhive create
        if [ -d "archives/${BACKUP_DATE}" ] && [ -n "$(ls -A archives/${BACKUP_DATE} 2>/dev/null)" ]; then
          echo "has_archives=true" >> $GITHUB_OUTPUT
          
          # NumÄƒrÄƒ arhivele
          ARCHIVE_COUNT=$(ls -1 archives/${BACKUP_DATE}/*.tar.gz 2>/dev/null | wc -l)
          echo "archive_count=$ARCHIVE_COUNT" >> $GITHUB_OUTPUT
        else
          echo "has_archives=false" >> $GITHUB_OUTPUT
          echo "archive_count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: CreeazÄƒ arhivÄƒ master cu toate backup-urile
      if: steps.process.outputs.has_archives == 'true'
      run: |
        echo "ğŸ“¦ Creez arhiva master cu toate repository-urile..."
        
        cd "archives/${BACKUP_DATE}"
        tar -czf "../../all_repos_backup_${BACKUP_DATE}.tar.gz" *.tar.gz
        cd ../..
        
        if [ -f "all_repos_backup_${BACKUP_DATE}.tar.gz" ]; then
          MASTER_SIZE=$(du -h "all_repos_backup_${BACKUP_DATE}.tar.gz" | cut -f1)
          echo "MASTER_ARCHIVE=all_repos_backup_${BACKUP_DATE}.tar.gz" >> $GITHUB_ENV
          echo "MASTER_SIZE=$MASTER_SIZE" >> $GITHUB_ENV
          echo "âœ… ArhivÄƒ master creatÄƒ: $MASTER_SIZE"
        else
          echo "âš ï¸ Eroare la crearea arhivei master"
        fi
    
    - name: SalveazÄƒ arhivele Ã®n repository
      if: steps.process.outputs.has_archives == 'true'
      run: |
        echo "ğŸ’¾ Salvez arhivele Ã®n repository..."
        
        git add archives/
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ Nu sunt modificÄƒri de salvat"
        else
          git commit -m "ğŸ“¦ Backup automat ${BACKUP_DATE} la ${BACKUP_TIME} - ${BACKUP_DATE}" \
                     -m "Repository-uri cu modificÄƒri: ${{ steps.process.outputs.changed }}" \
                     -m "Repository-uri fÄƒrÄƒ modificÄƒri: ${{ steps.process.outputs.unchanged }}" \
                     -m "Total arhive: ${{ steps.process.outputs.archive_count }}"
          
          git push origin main
          echo "âœ… Arhivele au fost salvate Ã®n repository"
        fi
    
    - name: CreeazÄƒ GitHub Release cu raport complet
      if: steps.process.outputs.has_archives == 'true'
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GH_PAT }}
        tag_name: backup-${{ env.BACKUP_DATE }}
        name: "ğŸ—„ï¸ Backup ${{ env.BACKUP_DATE }} â€¢ ${{ env.BACKUP_TIME }}"
        body: |
          # ğŸ“¦ Raport Backup Automat Zilnic
          
          ## ğŸ“… InformaÈ›ii generale
          
          | Detaliu | Valoare |
          |---------|---------|
          | **Data backup** | ${{ env.BACKUP_DATE }} |
          | **Ora backup** | ${{ env.BACKUP_TIME }} |
          | **Total repository-uri** | ${{ steps.get_repos.outputs.total_repos }} |
          | **âœ… Cu modificÄƒri** | ${{ steps.process.outputs.changed }} |
          | **â—‹ FÄƒrÄƒ modificÄƒri** | ${{ steps.process.outputs.unchanged }} |
          | **âš ï¸ Erori** | ${{ steps.process.outputs.errors }} |
          | **ğŸ“¦ Total arhive** | ${{ steps.process.outputs.archive_count }} |
          | **ğŸ’¾ ArhivÄƒ master** | ${{ env.MASTER_SIZE }} |
          
          ---
          
          ## âœ… Repository-uri cu MODIFICÄ‚RI (ultimele 24 ore)
          
          ${{ steps.process.outputs.changed_list }}
          
          ---
          
          ## â—‹ Repository-uri FÄ‚RÄ‚ modificÄƒri recente
          
          ${{ steps.process.outputs.unchanged_list }}
          
          ---
          
          ## âš ï¸ Erori / Avertismente
          
          ${{ steps.process.outputs.error_list }}
          
          ---
          
          ## ğŸ“¥ Cum sÄƒ descarci backup-urile
          
          ### OpÈ›iunea 1: Arhiva master (RECOMANDAT)
          DescarcÄƒ fiÈ™ierul **`all_repos_backup_${{ env.BACKUP_DATE }}.tar.gz`** de mai jos.  
          ConÈ›ine toate repository-urile Ã®ntr-o singurÄƒ arhivÄƒ.
```bash
          # DezarhiveazÄƒ
          tar -xzf all_repos_backup_${{ env.BACKUP_DATE }}.tar.gz
          
          # Apoi dezarhiveazÄƒ fiecare repository individual
          tar -xzf nume_repository_${{ env.BACKUP_DATE }}.tar.gz
