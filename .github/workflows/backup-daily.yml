name: Backup Zilnic

on:
  schedule:
    - cron: '0 6 * * *'  # 08:00 dimineaÈ›a ora RomÃ¢niei (6 UTC)
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository backup
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configurare Git
      run: |
        git config --global user.name "Backup Bot"
        git config --global user.email "cristianiftodexyz@gmail.com"
    
    - name: CreeazÄƒ folder pentru arhive
      run: |
        mkdir -p archives
        DATE=$(date +%Y-%m-%d)
        mkdir -p "archives/$DATE"
        echo "BACKUP_DATE=$DATE" >> $GITHUB_ENV
        echo "BACKUP_TIME=$(date '+%H:%M:%S')" >> $GITHUB_ENV
    
    - name: ObÈ›ine lista repository-urilor
      id: repos
      run: |
        echo "ğŸ“‹ ObÈ›in lista repository-urilor..."
        REPOS=$(curl -s "https://api.github.com/users/CristiWDT1881/repos?per_page=100&type=all" | jq -r '.[].name')
        
        echo "Repository-uri gÄƒsite:"
        echo "$REPOS"
        
        REPO_COUNT=$(echo "$REPOS" | wc -l)
        echo "total_repos=$REPO_COUNT" >> $GITHUB_OUTPUT
        
        echo "repos<<EOF" >> $GITHUB_OUTPUT
        echo "$REPOS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Backup repository-uri
      id: backup
      run: |
        CHANGED=0
        UNCHANGED=0
        CHANGED_LIST=""
        UNCHANGED_LIST=""
        ERRORS=""
        
        for repo in ${{ steps.repos.outputs.repos }}; do
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Procesez: $repo"
          
          # Skip repository-ul curent
          if [ "$repo" == "github-backup-automation" ]; then
            echo "âŠ˜ Skip (repository curent)"
            continue
          fi
          
          # CloneazÄƒ
          if git clone --quiet --depth=50 "https://github.com/CristiWDT1881/$repo.git" "temp_$repo" 2>/dev/null; then
            cd "temp_$repo"
            
            # VerificÄƒ modificÄƒri ultimele 24h
            COMMITS=$(git log --since="24 hours ago" --oneline 2>/dev/null | wc -l)
            LAST_COMMIT=$(git log -1 --pretty=format:"%h - %s (%cr)" 2>/dev/null || echo "N/A")
            
            if [ $COMMITS -gt 0 ]; then
              echo "âœ“ $COMMITS modificÄƒri recente"
              CHANGED=$((CHANGED + 1))
              CHANGED_LIST="${CHANGED_LIST}- **${repo}**: ${COMMITS} commit(uri) - ${LAST_COMMIT}\n"
              STATUS="MODIFICAT"
            else
              echo "â—‹ FÄƒrÄƒ modificÄƒri recente"
              UNCHANGED=$((UNCHANGED + 1))
              UNCHANGED_LIST="${UNCHANGED_LIST}- ${repo}: ${LAST_COMMIT}\n"
              STATUS="NESCHIMBAT"
            fi
            
            cd ..
            
            # CreeazÄƒ arhivÄƒ ÃNTOTDEAUNA
            ARCHIVE_NAME="${repo}_${BACKUP_DATE}.tar.gz"
            echo "ğŸ“¦ Creez arhivÄƒ..."
            
            tar -czf "archives/${BACKUP_DATE}/${ARCHIVE_NAME}" \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='__pycache__' \
              --exclude='*.pyc' \
              --exclude='.env' \
              "temp_$repo" 2>/dev/null
            
            SIZE=$(du -h "archives/${BACKUP_DATE}/${ARCHIVE_NAME}" | cut -f1)
            echo "âœ“ ArhivÄƒ creatÄƒ: ${SIZE} [${STATUS}]"
            
            rm -rf "temp_$repo"
          else
            echo "âš ï¸ Eroare la clonare (posibil gol sau inaccesibil)"
            ERRORS="${ERRORS}- ${repo}: Nu a putut fi accesat\n"
          fi
        done
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š SUMAR:"
        echo "Repository-uri cu modificÄƒri: $CHANGED"
        echo "Repository-uri fÄƒrÄƒ modificÄƒri: $UNCHANGED"
        echo "Total arhive create: $((CHANGED + UNCHANGED))"
        
        echo "changed=$CHANGED" >> $GITHUB_OUTPUT
        echo "unchanged=$UNCHANGED" >> $GITHUB_OUTPUT
        echo "total=$((CHANGED + UNCHANGED))" >> $GITHUB_OUTPUT
        
        echo "changed_list<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "unchanged_list<<EOF" >> $GITHUB_OUTPUT
        echo -e "$UNCHANGED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "errors<<EOF" >> $GITHUB_OUTPUT
        echo -e "$ERRORS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # VerificÄƒ dacÄƒ existÄƒ arhive
        if [ -d "archives/${BACKUP_DATE}" ] && [ "$(ls -A archives/${BACKUP_DATE})" ]; then
          echo "has_archives=true" >> $GITHUB_OUTPUT
        else
          echo "has_archives=false" >> $GITHUB_OUTPUT
        fi
    
    - name: CreeazÄƒ arhivÄƒ master cu toate backup-urile
      if: steps.backup.outputs.has_archives == 'true'
      run: |
        cd archives/${BACKUP_DATE}
        tar -czf "../../all_repos_backup_${BACKUP_DATE}.tar.gz" *.tar.gz
        cd ../..
        
        MASTER_SIZE=$(du -h "all_repos_backup_${BACKUP_DATE}.tar.gz" | cut -f1)
        echo "MASTER_ARCHIVE=all_repos_backup_${BACKUP_DATE}.tar.gz" >> $GITHUB_ENV
        echo "MASTER_SIZE=$MASTER_SIZE" >> $GITHUB_ENV
        
        echo "âœ“ ArhivÄƒ master creatÄƒ: $MASTER_SIZE"
    
    - name: Commit arhivele Ã®n repository
      if: steps.backup.outputs.has_archives == 'true'
      run: |
        git add archives/
        git commit -m "Backup automat ${BACKUP_DATE} - ${BACKUP_TIME}" || echo "Nimic de commit"
        git push || echo "Nimic de push"
    
    - name: CreeazÄƒ Release
      if: steps.backup.outputs.has_archives == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: backup-${{ env.BACKUP_DATE }}
        name: "ğŸ—„ï¸ Backup ${{ env.BACKUP_DATE }} ora ${{ env.BACKUP_TIME }}"
        body: |
          ## ğŸ“¦ Raport Backup Zilnic
          
          **ğŸ“… Data:** ${{ env.BACKUP_DATE }} la ora ${{ env.BACKUP_TIME }}  
          **ğŸ“Š Total repository-uri:** ${{ steps.repos.outputs.total_repos }}  
          **âœ… Cu modificÄƒri:** ${{ steps.backup.outputs.changed }}  
          **â—‹ FÄƒrÄƒ modificÄƒri:** ${{ steps.backup.outputs.unchanged }}  
          **ğŸ“¦ Total arhive create:** ${{ steps.backup.outputs.total }}  
          **ğŸ’¾ Dimensiune arhivÄƒ master:** ${{ env.MASTER_SIZE }}
          
          ---
          
          ### âœ… Repository-uri cu MODIFICÄ‚RI (ultimele 24h):
          ${{ steps.backup.outputs.changed_list }}
          
          ### â—‹ Repository-uri FÄ‚RÄ‚ modificÄƒri:
          ${{ steps.backup.outputs.unchanged_list }}
          
          ### âš ï¸ Erori/Avertismente:
          ${{ steps.backup.outputs.errors }}
          
          ---
          
          ### ğŸ“¥ DescÄƒrcare
          - **ArhivÄƒ master** (toate repo-urile): Vezi mai jos
          - **Arhive individuale**: Ãn folder `archives/${{ env.BACKUP_DATE }}/`
          
          ### ğŸ“§ NotificÄƒri trimise cÄƒtre:
          - cristianiftodexyz@gmail.com
          - tehnicdti@protonmail.com
          
          ---
          *ğŸ¤– Backup automat - GitHub Actions*
        files: ${{ env.MASTER_ARCHIVE }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Raport final (chiar dacÄƒ nu sunt modificÄƒri)
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ¯ RAPORT FINAL - ${{ env.BACKUP_DATE }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        if [ "${{ steps.backup.outputs.has_archives }}" == "true" ]; then
          echo "âœ… Backup finalizat cu succes!"
          echo "ğŸ“¦ Arhive create: ${{ steps.backup.outputs.total }}"
          echo "âœ“ Cu modificÄƒri: ${{ steps.backup.outputs.changed }}"
          echo "â—‹ FÄƒrÄƒ modificÄƒri: ${{ steps.backup.outputs.unchanged }}"
          echo "ğŸ’¾ ArhivÄƒ master: ${{ env.MASTER_SIZE }}"
          echo "ğŸ“§ NotificÄƒri trimise pe email"
        else
          echo "â„¹ï¸ Nu au fost create arhive"
          echo "ğŸ“§ Email trimis cu status (fÄƒrÄƒ arhive)"
        fi
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Vei primi notificare pe email de la GitHub."
        echo "Arhivele sunt salvate Ã®n:"
        echo "- Repository: archives/${{ env.BACKUP_DATE }}/"
        echo "- Release: all_repos_backup_${{ env.BACKUP_DATE }}.tar.gz"
